<div class="container-turnos">
  <!-- Verificación de permisos -->
  <div *ngIf="!puedeVerComponente() && !cargando" class="sin-permisos">
    <div class="mensaje-sin-permisos">
      <h3>Acceso Restringido</h3>
      <p *ngIf="usuarioActual?.perfil === 'paciente'">
        Esta sección está temporalmente disponible solo para especialistas.
      </p>
      <p *ngIf="!usuarioActual">
        Debe iniciar sesión para acceder a esta sección.
      </p>
    </div>
  </div>

  <!-- Contenido para especialistas -->
  <div *ngIf="puedeVerComponente()">
    <div class="header">
      <h2>Mis Turnos - Especialista</h2>
      
      <!-- Filtro principal -->
      <div class="filtro-container">
        <div class="filtro-input">
          <input 
            type="text" 
            [(ngModel)]="filtro" 
            placeholder="Filtrar por especialidad o paciente..."
            class="input-filtro"
            (input)="aplicarFiltros()"
          >
          <button 
            *ngIf="filtro" 
            (click)="limpiarFiltro()" 
            class="btn-limpiar"
            title="Limpiar filtro"
          >
            ✕
          </button>
        </div>
        <small class="filtro-ayuda">
          Puede filtrar por especialidad o nombre del paciente (sin importar tildes o mayúsculas)
        </small>
      </div>

      <!-- Filtros por estado -->
      <div class="filtros-estado">
        <h4>Filtrar por estado:</h4>
        <div class="botones-estado">
          <button 
            *ngFor="let estado of estadosDisponibles"
            (click)="filtrarPorEstado(estado.valor)"
            class="btn-estado"
            [class.activo]="filtroEstado === estado.valor"
          >
            {{ estado.texto }}
          </button>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="cargando" class="loading">
      <div class="spinner"></div>
      <p>Cargando turnos...</p>
    </div>

    <!-- Lista de turnos -->
    <div *ngIf="!cargando" class="turnos-lista">
      <div *ngIf="turnosFiltrados.length === 0" class="sin-turnos">
        <p>{{ filtro || filtroEstado ? 'No se encontraron turnos que coincidan con los filtros aplicados' : 'No tienes turnos asignados' }}</p>
      </div>

      <div *ngFor="let turno of turnosFiltrados" class="turno-card">
        <div class="turno-header">
          <div class="paciente-info">
            <img 
              [src]="turno.paciente?.imagen_perfil_1 || 'assets/default-avatar.png'" 
              [alt]="turno.paciente?.nombre"
              class="avatar-paciente"
            >
            <div class="datos-paciente">
              <h3>{{ turno.paciente?.nombre }} {{ turno.paciente?.apellido }}</h3>
              <p class="obra-social">{{ turno.paciente?.obra_social }}</p>
            </div>
          </div>
          
          <div class="estado-turno" [ngClass]="obtenerClaseEstado(turno.estado)">
            {{ obtenerTextoEstado(turno.estado) }}
          </div>
        </div>

        <div class="turno-body">
          <div class="turno-detalles">
            <div class="detalle-item">
              <strong>Especialidad:</strong> {{ turno.especialidad }}
            </div>
            <div class="detalle-item">
              <strong>Fecha:</strong> {{ formatearFecha(turno.fecha) }}
            </div>
            <div class="detalle-item">
              <strong>Hora:</strong> {{ formatearHora(turno.hora) }}
            </div>
            <div *ngIf="turno.comentario_paciente" class="detalle-item">
              <strong>Comentario del paciente:</strong> {{ turno.comentario_paciente }}
            </div>
          </div>

          <!-- Acciones -->
          <div class="acciones">
            <!-- Aceptar (solo para estado 'creado') -->
            <button 
              *ngIf="puedeAceptar(turno)" 
              (click)="aceptarTurno(turno)"
              class="btn btn-aceptar"
              title="Aceptar turno"
            >
              Aceptar
            </button>

            <!-- Rechazar (solo para estado 'creado') -->
            <button 
              *ngIf="puedeRechazar(turno)" 
              (click)="abrirModalRechazar(turno)"
              class="btn btn-rechazar"
              title="Rechazar turno"
            >
              Rechazar
            </button>

            <!-- Cancelar (solo para estado 'aceptado') -->
            <button 
              *ngIf="puedeCancelar(turno)" 
              (click)="abrirModalCancelar(turno)"
              class="btn btn-cancelar"
              title="Cancelar turno"
            >
              Cancelar
            </button>

            <!-- Finalizar (solo para estado 'aceptado') -->
            <button 
              *ngIf="puedeFinalizar(turno)" 
              (click)="abrirModalFinalizar(turno)"
              class="btn btn-finalizar"
              title="Finalizar turno"
            >
              Finalizar
            </button>

            <!-- Ver Diagnóstico (solo para estado 'finalizado') -->
            <button 
              *ngIf="puedeVerDiagnostico(turno)" 
              (click)="abrirModalDiagnostico(turno)"
              class="btn btn-ver-diagnostico"
              title="Ver diagnóstico"
            >
              Ver Diagnóstico
            </button>

            <!-- Ver Motivo Cancelación (solo para estado 'cancelado') -->
            <button 
              *ngIf="puedeVerMotivoCancelacion(turno)" 
              (click)="abrirModalMotivoCancelacion(turno)"
              class="btn btn-ver-cancelacion"
              title="Ver motivo de cancelación"
            >
              Ver Motivo
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Cancelar -->
    <div *ngIf="mostrarModalCancelar" class="modal-overlay" (click)="cerrarModales()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Cancelar Turno</h3>
          <button (click)="cerrarModales()" class="btn-cerrar">✕</button>
        </div>
        <div class="modal-body">
          <p>¿Está seguro que desea cancelar el turno con {{ turnoSeleccionado?.paciente?.nombre }} {{ turnoSeleccionado?.paciente?.apellido }}?</p>
          <div class="form-group">
            <label for="comentarioCancelacion">Motivo de cancelación *</label>
            <textarea 
              id="comentarioCancelacion"
              [(ngModel)]="comentarioCancelacion" 
              placeholder="Ingrese el motivo de la cancelación..."
              rows="4"
              class="textarea"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button (click)="cerrarModales()" class="btn btn-secundario">Cancelar</button>
          <button 
            (click)="confirmarCancelacion()" 
            class="btn btn-primario"
            [disabled]="!comentarioCancelacion.trim()"
          >
            Confirmar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Rechazar -->
    <div *ngIf="mostrarModalRechazar" class="modal-overlay" (click)="cerrarModales()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Rechazar Turno</h3>
          <button (click)="cerrarModales()" class="btn-cerrar">✕</button>
        </div>
        <div class="modal-body">
          <p>¿Está seguro que desea rechazar el turno con {{ turnoSeleccionado?.paciente?.nombre }} {{ turnoSeleccionado?.paciente?.apellido }}?</p>
          <div class="form-group">
            <label for="comentarioRechazo">Motivo de rechazo *</label>
            <textarea 
              id="comentarioRechazo"
              [(ngModel)]="comentarioRechazo" 
              placeholder="Ingrese el motivo del rechazo..."
              rows="4"
              class="textarea"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button (click)="cerrarModales()" class="btn btn-secundario">Cancelar</button>
          <button 
            (click)="confirmarRechazo()" 
            class="btn btn-primario"
            [disabled]="!comentarioRechazo.trim()"
          >
            Confirmar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Finalizar -->
    <div *ngIf="mostrarModalFinalizar" class="modal-overlay" (click)="cerrarModales()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Finalizar Turno</h3>
          <button (click)="cerrarModales()" class="btn-cerrar">✕</button>
        </div>
        <div class="modal-body">
          <p>Complete la información del turno con {{ turnoSeleccionado?.paciente?.nombre }} {{ turnoSeleccionado?.paciente?.apellido }}</p>
          <div class="form-group">
            <label for="resenaConsulta">Reseña de la consulta *</label>
            <textarea 
              id="resenaConsulta"
              [(ngModel)]="resenaConsulta" 
              placeholder="Ingrese la reseña de la consulta..."
              rows="4"
              class="textarea"
            ></textarea>
          </div>
          <div class="form-group">
            <label for="diagnostico">Diagnóstico *</label>
            <textarea 
              id="diagnostico"
              [(ngModel)]="diagnostico" 
              placeholder="Ingrese el diagnóstico..."
              rows="4"
              class="textarea"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button (click)="cerrarModales()" class="btn btn-secundario">Cancelar</button>
          <button 
            (click)="confirmarFinalizacion()" 
            class="btn btn-primario"
            [disabled]="!resenaConsulta.trim() || !diagnostico.trim()"
          >
            Finalizar Turno
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Ver Diagnóstico -->
    <div *ngIf="mostrarModalDiagnostico" class="modal-overlay" (click)="cerrarModales()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Diagnóstico del Turno</h3>
          <button (click)="cerrarModales()" class="btn-cerrar">✕</button>
        </div>
        <div class="modal-body">
          <p><strong>Paciente:</strong> {{ turnoSeleccionado?.paciente?.nombre }} {{ turnoSeleccionado?.paciente?.apellido }}</p>
          <p><strong>Fecha:</strong> {{ formatearFecha(turnoSeleccionado?.fecha) }} - {{ formatearHora(turnoSeleccionado?.hora) }}</p>
          
          <div *ngIf="turnoSeleccionado?.comentario_especialista" class="form-group">
            <label>Reseña de la consulta:</label>
            <div class="resena-texto">{{ turnoSeleccionado.comentario_especialista }}</div>
          </div>
          
          <div *ngIf="turnoSeleccionado?.diagnostico" class="form-group">
            <label>Diagnóstico:</label>
            <div class="resena-texto">{{ turnoSeleccionado.diagnostico }}</div>
          </div>
        </div>
        <div class="modal-footer">
          <button (click)="cerrarModales()" class="btn btn-primario">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal Ver Motivo Cancelación -->
    <div *ngIf="mostrarModalMotivoCancelacion" class="modal-overlay" (click)="cerrarModales()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Motivo de Cancelación</h3>
          <button (click)="cerrarModales()" class="btn-cerrar">✕</button>
        </div>
        <div class="modal-body">
          <p><strong>Paciente:</strong> {{ turnoSeleccionado?.paciente?.nombre }} {{ turnoSeleccionado?.paciente?.apellido }}</p>
          <p><strong>Fecha:</strong> {{ formatearFecha(turnoSeleccionado?.fecha) }} - {{ formatearHora(turnoSeleccionado?.hora) }}</p>
          
          <div class="form-group">
            <label>Motivo:</label>
            <div class="resena-texto">
              {{ turnoSeleccionado?.comentario_cancelacion || turnoSeleccionado?.comentario_rechazo || 'No se especificó motivo' }}
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button (click)="cerrarModales()" class="btn btn-primario">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
</div>